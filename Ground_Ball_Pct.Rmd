---
title: "GB%"
author: "Danny"
date: "10/19/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**First**, let's connect to our data.
```{r}
library(RMySQL)
library(tidyverse)
filter_db = function() {
  con = dbConnect(MySQL(), 
                  user="mbaadmin", 
                  password="gUZSaQAAwgDRhqZPPCqa", 
                  dbname="uiuc", 
                  host="prodbaseballmysqlohio.ciurqw3b29ox.us-east-2.rds.amazonaws.com")
  
  pitches = dbGetQuery(con, paste0("select * from tm_pitches"))
  
  dbDisconnect(con)
  return(pitches)
}

seasonTotals <- filter_db()
```

**Secondly** we'll be finding ground ball % as a result of multiple variables is to filter the data that only includes balls in play.

```{r}
seasonTotals$count <- paste(seasonTotals$Balls, seasonTotals$Strikes)
seasonTotals %>%
  filter(PitchCall == "InPlay") -> in_play
```

**Thirdly** we need to quantify the presence of ground balls.

```{r}
seasonTotals <- seasonTotals %>%
  add_column(groundball = NA)
seasonTotals$groundball <- ifelse(grepl("GroundBall",seasonTotals$AutoHitType),1,0) 

in_play <- in_play %>%
  add_column(groundball = NA)
in_play$groundball <- ifelse(grepl("GroundBall",in_play$AutoHitType),1,0)
```

**First idea** Let's see if a ground ball is more likely to happen early in the count.

```{r}
seasonTotals %>%
  group_by(PitchofPA) %>%
  summarise(N = n(), 
            avg_ground_ball = mean(groundball)) -> ab_length
dat <- data.frame(x=c(ab_length$PitchofPA), y= c(ab_length$avg_ground_ball))
barplot(dat$y, names.arg=dat$x, xlab = "Pitch of At Bat", ylab = "Probability of a Groundball")
```

As it turns out, a pitcher is most likely to roll a ground ball on the fifth to seventh pitch in the at bat. This doesn't tell us much. 

Let's figure out percentages of balls in play hit on the ground by pitch type and count.

```{r}
in_play %>%
  group_by(count,TaggedPitchType) %>%
  summarise(N = n(), 
            mean_ground_ball = mean(groundball)) %>%
  filter(N >= 10) %>%
  arrange(desc(N)) -> heat_map
library(tidyverse)
ggplot(heat_map, aes(x = TaggedPitchType, y = count, fill = mean_ground_ball, xlab = "Pitch Type", ylab = "Count")) +
  geom_tile()
heat_map %>%
  arrange(desc(mean_ground_ball))
```

The list helps clarify the heat map in showing best ground ball pitches by count to worst.

**Regression**

I will regress the result of GroundBall over many other predictor variables and see which have a significant ability to produce a ground ball.

```{r}
g <- lm(groundball ~ ExitSpeed + Angle + pfxz + z0 + 
    vy0 + ax0 + EffectiveVelo + MaxHeight + SpeedDrop + 
    ContactPositionX + ContactPositionY + PitchTrajectoryXc0 + PitchTrajectoryYc0 + PitchTrajectoryZc2 + 
    HitTrajectoryXc0 + HitTrajectoryYc0 + HitTrajectoryYc1, 
    data = in_play)
summary(g)
```

To be elaborated on soon...