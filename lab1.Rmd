---
title: "Lab 1"
author: ""
date: "Due on 9/9/2022 at 11:59 pm"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


**Instructions:** This lab report needs to be professional. Only report relevant and finalized code. Your writing should be concise and void of spelling errors. Use code chunk options to hide unnecessary messages/warnings. Your report should be reproducible. Reports that involve simulations need to have the random seed specified so that simulation results are reproducible. You are allowed to work on this lab assignment in groups of 2-3. You still need to submit an individual lab report if you do work in a group, and you need to list your collaborators. \vspace*{0.5cm}


**Question 1** In lecture it was demonstrated that baseball is a game of offense, pitching, and defense with a regression model that considered expected run differential as a function of explanatory variables OPS, WHIP, and FP. Do the following:

 - Fit a similar regression model with runs as the response variable. Report problems with this model. Investigate problematic residuals to discover what went wrong. Fix the problem with this model by adding categorical variable(s) to the list of explanatory variables. Briefly explain what went wrong. 
 
```{r}
#Loading Libraries
library(tidyverse)
library(faraway)
library(Lahman)
library(dplyr)
data(Teams)
```

```{r}
#I took the following variables from Teams and created a new dataframe only including the year 1900 onward while constructing Run Differential, On Base %, Slugging %, OPS, WHIP, FIP, and Singles from the existing data.
dat <- Teams %>% 
	select(yearID, franchID, W, L, AB, H, X2B, X3B, HR, BB, HBP, SF, 
				 HA, HRA, BBA, SOA, IPouts, FP, R, RA) %>% 
	filter(yearID >= 1900) %>%
	replace_na(list(HBP = 0, SF = 0)) %>% 
	mutate(RD = (R - RA) / (W + L), X1B = H - (X2B + X3B + HR)) %>% 
	mutate(OBP = (H + BB + HBP)/(AB + BB + HBP + SF)) %>%  
	mutate(SLG = (X1B + 2*X2B + 3*X3B + 4*HR)/AB) %>% 
	mutate(OPS = OBP + SLG) %>% 
	mutate(WHIP = 3*(HA + BBA)/IPouts) %>% 
	mutate(FIP = 3*(13*HRA + 3*BBA - 2*SOA)/IPouts)
head(dat, 3)
```

```{r}
#All 3 predictors are significant, however the Adjusted R-Squared leaves more to be desired.
m <- lm(R ~ OPS + WHIP + FP, data = dat)
summary(m)
```

 - We can significantly improve the regression model in the notes through a principled rescaling of OPS, WHIP, and FP. Split the Teams data frame by \texttt{yearID} and, for each year, create variables \texttt{OPSscale = OPS/avgOPS}, \texttt{WHIPscale = avgWHIP/WHIP}, and \texttt{FPscale = avgFP/FP} which require you to first create league average variables \texttt{avgOPS}, \texttt{avgWHIP}, and \texttt{avgFP}. Fit the linear regression model with runs differential as the response and explanatory variables \texttt{OPSscale}, \texttt{WHIPscale}, and \texttt{FPscale}, and report relevant output. Why does this model perform so much better than the model in the notes? Support your answer. Hint: functions \texttt{split}, \texttt{do.call}, and \texttt{lapply} are useful.
 
```{r}
#Creating the instructed variables
dat2 <- group_by(dat,yearID)
dat3 <- dat2 %>%
  mutate(avgOPS = mean(OPS)) %>%
  mutate(avgWHIP = mean(WHIP)) %>%
  mutate(avgFP = mean(FP)) %>%
  mutate(OPSscale = OPS/avgOPS) %>%
  mutate(WHIPscale = avgWHIP/WHIP) %>%
  mutate(FPscale = avgFP/FP)
head(dat3)
```
```{r}
#All 3 variables are significant for run differential, and the Adjusted R-squared looks better
m2 <- lm(RD ~ WHIPscale + FPscale + OPSscale, data = dat3)
summary(m2)
```

```{r}
par(mfrow = c(2,2))
plot(m2)
```

```{r}
#Augmenting the problem for better fit
library(broom)
dat_aug <- augment(m2, data = dat3) 
dat_aug %>% 
  mutate(rmse = sqrt((mean(.resid^2)))) %>%
  summarise(N = n(), 
            within_1rmse = sum(abs(.resid) < rmse),  
            within_2rmse = sum(abs(.resid) < 2 * rmse)) %>% 
  mutate(within_1rmse_pct = within_1rmse / N, 
         within_2rmse_pct = within_2rmse / N)
dat_aug %>% filter(abs(.resid) >= 1) %>% 
	select(yearID, franchID, W, RD, OPS, WHIP, FP, .resid, .fitted) %>% 
	mutate(across(4:9, round, 3)) %>% 
	arrange((.resid))
```

**Question 2** Choose 3 batters and 3 pitchers that have played in at least 10 seasons and do the following: 

Batters: sheripa01, mccutan01, avilaa01
Pitchers: lylesp01, melanma01, cokeph01

 - Display the seasonal statistics for these players. The following statistics should be included for batters (derivations of unconventional statistics are in parentheses): year, G, AB, R, H, X2B, X3B, HR, RBI, SB, CS, SBpct (SB / (SB + CS)), BB, SO, OBP, SLG, OPS. The following statistics should be included for pitchers: year, W,  L, IPouts, H, ER, HR, BB, HBP, SO, ERA, WHIP, SOper9 (SO / IP * 9), SOperBB (SO / BB). These statistics can be found in or computed from statistics that are found in the \texttt{Batting} and \texttt{Pitching} dataframes in the \texttt{Lahman} package.
 
```{r}
#Taking our three position players' season by season stat lines and displaying them
data("Batting")
three_players <- Batting %>%
  select(playerID, yearID, G, AB, R, H, X2B, X3B, HR, RBI, SB, CS, BB, SO, HBP) %>%
  mutate(X1B = H - X2B - X3B - HR) %>%
  mutate(OBP = (H + BB + HBP)/(AB + BB + HBP)) %>% 
	mutate(SLG = (X1B + 2*X2B + 3*X3B + 4*HR)/AB) %>% 
	mutate(OPS = OBP + SLG) %>%
  mutate(SBpct = SB / (SB + CS)) 
Pujols <- three_players %>%
  filter(playerID == "pujolal01")
Trout <- three_players %>%
  filter(playerID == "troutmi01")
Judge <- three_players %>%
  filter(playerID == "judgeaa01")
print(Pujols)
print(Trout)
print(Judge)
```
```{r}
#Taking our three pitchers' season by season stat lines and displaying them
data("Pitching")
three_pitchers <- Pitching %>%
  select(playerID, yearID, W,  L, IPouts, H, ER, HR, BB, HBP, SO, ERA) %>%
  mutate(IP = IPouts/3) %>%
  mutate(SOper9 = (SO / IP * 9)) %>% 
  mutate(SOperBB = SO / BB) %>%
  mutate(WHIP = (BB + H) / IPouts)
Verlander <- three_pitchers %>%
  filter(playerID == "verlaju01")
Maddux <- three_pitchers %>%
  filter(playerID == "maddugr01")
deGrom <- three_pitchers %>%
  filter(playerID == "degroja01")
print(Verlander)
print(Maddux)
print(deGrom)
```
 - Create career stat lines for each of the players that you selected. Be careful about how these statistics are calculated.
```{r}
#Career Stats database for Aaron Judge, Mike Trout, and Albert Pujols
data("Batting")
career_stats_batting <- Batting %>%
  select(playerID, yearID, G, AB, R, H, X2B, X3B, HR, RBI, SB, CS, BB, SO, HBP) %>%
  group_by(playerID) %>%
  summarise(careerG = sum(G), careerAB = sum(AB), careerR = sum(R), careerH = sum(H), careerX2B = sum(X2B), careerX3B = sum(X3B), careerHR = sum(HR), careerRBI = sum(RBI), careerSB = sum(SB), careerCS = sum(CS), careerBB = sum(BB), careerSO = sum(SO), careerHBP = sum(HBP)) %>%
  mutate(careerX1B = careerH - careerX2B - careerX3B - careerHR) %>%
  mutate(careerOBP = (careerH + careerBB + careerHBP)/(careerAB + careerBB + careerHBP)) %>%
  mutate(careerSLG = (careerX1B + 2*careerX2B + 3*careerX3B + 4*careerHR)/careerAB) %>%
  mutate(careerOPS = careerOBP + careerSLG) %>%
  mutate(careerSBpct = careerSB / (careerSB + careerCS)) %>% 
  filter(playerID == "pujolal01" | playerID == "troutmi01" | playerID == "judgeaa01") 
career_stats_batting
```

```{r}
#Career Stats database for Jacob deGrom, Justin Verlander, and Greg Maddux
data("Pitching")
career_stats_pitching <- Pitching %>%
  select(playerID, yearID, W,  L, IPouts, H, ER, HR, BB, HBP, SO, ERA) %>%
  group_by(playerID) %>%
  summarise(careerW = sum(W), careerL = sum(L), careerIP = sum(IPouts)/3, careerH = sum(H), careerER = sum(ER), careerHR = sum(HR), careerBB = sum(BB), careerHBP = sum(HBP), careerSO = sum(SO)) %>%
  mutate(careerERA = (careerER / careerIP) * 9) %>%
  mutate(careerSOper9 = (careerSO / careerIP) *9) %>%
  mutate(careerSOperBB = careerSO / careerBB) %>%
  mutate(careerWHIP = (careerH + careerBB) / careerIP) %>%
  filter(playerID == "degroja01" | playerID == "verlaju01" | playerID == "maddugr01")
career_stats_pitching
```
 
 - Provide a plot for career trajectories for one batting and one pitching statistic of your choice. These are two separate graphics, one for the batters and one for the pitchers. The graphics that you produce should display the trajectories of the 3 batters and the 3 pitchers. Provide interesting commentary on your graphic.

```{r} 
#Cumulative Home Runs for Aaron Judge, Mike Trout, and Albert Pujols
batDat <- Batting %>%
  inner_join(People, by = "playerID") %>%
  replace_na(list(HBP=0, SF=0, CS=0)) %>%
  mutate(Age = yearID - birthYear) %>%
  filter(playerID == "troutmi01" | playerID == "pujolal01" | playerID == "judgeaa01") %>%
  select(playerID, birthYear, Age, HR) %>%
  group_by(playerID) %>%
  mutate(CHR = cumsum(HR))

ggplot(batDat, aes(x = Age, y = CHR, linetype = playerID)) +
  geom_line()
```

```{r}
#Cumulative Strikeouts for Jacob deGrom, Justin Verlander, and Greg Maddux
pitchDat <- Pitching %>%
  inner_join(People, by = "playerID") %>%
  mutate(Age = yearID - birthYear) %>%
  filter(playerID == "degroja01" | playerID == "verlaju01" | playerID == "maddugr01") %>%
  select(playerID, birthYear, Age, SO) %>%
  group_by(playerID) %>%
  mutate(CSO = cumsum(SO))

ggplot(pitchDat, aes(x = Age, y = CSO, linetype = playerID)) +
  geom_line()
```


**Question 3** Problem 2 on page 28 of Analyzing Baseball Data with R

a.) 28/34
b.) 4.322581:1
c.) 304.2
d.) 0.8533916
 
**Question 4** Problem 3 on page 29 of Analyzing Baseball Data with R 

a.) 2 hours and 19 minutes
b.) Perhaps it could be that the double header messed up attendance or retrosheet doesn't carry the data.
c.) 3 extra base hits
d.) 0.333

